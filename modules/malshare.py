import requests
import os
import datetime
from .results import download
from .colors import bcolors

timestamp_now = datetime.datetime.now().strftime('%Y-%m-%d')

headers = {
    'User-Agent': "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36"
}


def malshare(export_bool=False, download_bool=False, output_bool=False):
    print("++++++++++++++++++++++++++++++++++++")
    print(bcolors.OKBLUE + "Brought to you by Malshare\n" \
                           "A free Malware repository providing researchers access to samples, malicous feeds, and Yara results.\n" \
                           "http://malshare.com" + bcolors.ENDC)
    print("++++++++++++++++++++++++++++++++++++")

    api = ""

    req = requests.get("http://www.malshare.com/api.php?api_key=" + api + "&action=getsourcesraw",
                           headers=headers)  # make api request
    directory = "malshare" + timestamp_now

    content = req.content.split()  # split response to array by \n

    if download_bool:
        try:
            os.mkdir(directory)
        except OSError:
            pass
        finally:
            for i in content:
                i = i.decode("utf-8")
                print("Downloading file " + i)

                download(i, directory)
                print("---------------------------")

    elif export_bool:
        try:
            with open(directory + ".txt", "w") as out:
                for i in content:
                    out.write(i + "|")
                print("Exported to " + directory + '.txt')
        except OSError as e:
            print(e.strerror)

    elif output_bool:

        print(req.content)

    else:
        print("Please specify: --download or --export or --output")
